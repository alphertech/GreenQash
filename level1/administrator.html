<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Content-Security-Policy meta removed for local development -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLOBAL-WORM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="adstyles.css">
    <style>
        /* Mobile menu overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        #logoutBtn {
            background-color: white;
            color: #2c3e50;
            padding: 10px 2px;
            position: fixed;
            top: 15px;
            right: 15px;
            border-radius: 15px 0 15px 0;
            border-style: groove;
            outline-color: #2c3e50;
            border-color: #2c3e50;
            font-size: 10px;
            z-index: 999;
        }

        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            color: #2c3e50;
            border-style: groove;
            border-radius: 0 15px 0 15px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            outline-color: #2c3e50;
        }

        /* Close button for sidebar on mobile */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 1001;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 999;
                position: fixed;
                height: 100vh;
                overflow-y: auto;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-close {
                display: block;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .header {
                padding-left: 70px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                width: 100%;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .action-btn {
                width: 35px;
                height: 35px;
            }
        }

        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }

            .mobile-menu-toggle {
                top: 15px;
                left: 15px;
                width: 35px;
                height: 35px;
            }

            .header h1 {
                font-size: 0.8rem;
            }

            .section-title {
                font-size: 0.6rem;
            }
        }
 
        /* Ensure tables are scrollable on mobile */
        .table-container {
            overflow-x: auto;
        }
        
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" id="sidebarClose">
            <i class="fas fa-times"></i>
        </button>
        <div class="logo">
            <h2>HOLLY-<span>MARMAID</span></h2>
        </div>
        <ul class="menu" id="menu">
            <li class="menu-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </li>
            <li class="menu-item" data-section="users">
                <i class="fas fa-users"></i>
                <span>Users</span>
            </li>
            <li class="menu-item" data-section="earnings">
                <i class="fas fa-chart-line"></i>
                <span>Earnings</span>
            </li>
            <li class="menu-item" data-section="withdrawals">
                <i class="fas fa-money-bill-wave"></i>
                <span>Withdrawals</span>
            </li>
            <li class="menu-item" data-section="referrals">
                <i class="fas fa-network-wired"></i>
                <span>Referrals</span>
            </li>
            <li class="menu-item" data-section="contents">
                <i class="fas fa-file-alt"></i>
                <span>Contents</span>
            </li>
            <li class="menu-item" data-section="payments">
                <i class="fas fa-credit-card"></i>
                <span>Payments</span>
            </li>
            <li class="menu-item" data-section="statistics">
                <i class="fas fa-chart-bar"></i>
                <span>Statistics</span>
            </li>
            <li class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </li>
            <li class="menu-item" data-section="audit">
                <i class="fas fa-history"></i>
                <span>Audit Log</span>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header">
            <div>
                <h2></h2>
                <h1 id="pageTitle">HOLLY-<span>MARMAID</span></h1>
                <hr>
                <p id="pageDescription">Welcome back, Mr. James!</p>
            </div>
            <div class="admin-info">
                <!-- <div class="admin-avatar" id="adminAvatar">A</div> -->
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>EXIT
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="section-container active" id="dashboard">
            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded dynamically -->
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" data-action="addUser">
                    <i class="fas fa-user-plus"></i>
                    <h4>Add User</h4>
                </div>
                <div class="quick-action-btn" data-action="processWithdrawals">
                    <i class="fas fa-money-check-alt"></i>
                    <h4>Process Payouts</h4>
                </div>
                <div class="quick-action-btn" data-action="sendNotification">
                    <i class="fas fa-bell"></i>
                    <h4>Send Notification</h4>
                </div>
                <div class="quick-action-btn" data-action="generateReport">
                    <i class="fas fa-file-export"></i>
                    <h4>Generate Report</h4>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">User Growth</h3>
                    <canvas id="userGrowthChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Earnings Distribution</h3>
                    <canvas id="earningsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Withdrawal Status</h3>
                    <canvas id="withdrawalChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Activity Overview</h3>
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="table-container">
                <div class="section-header">
                    <h2 class="section-title">Recent Activities</h2>
                    <button class="btn btn-primary" onclick="loadRecentActivities()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="recentActivities">
                    <!-- Activities will be loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="section-container" id="users">
            <div class="section-header">
                <h2 class="section-title">User Management</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                    <button class="export-btn" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearch" placeholder="Search users by name, email, or ID..."
                    onkeyup="searchUsers(this.value)">
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="userStatusFilter" onchange="filterUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Rank</label>
                    <select id="userRankFilter" onchange="filterUsers()">
                        <option value="">All Ranks</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="moderator">Moderator</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date Range</label>
                    <input type="date" id="userDateFrom" onchange="filterUsers()">
                </div>
                <div class="filter-group">
                    <label>to</label>
                    <input type="date" id="userDateTo" onchange="filterUsers()">
                </div>
            </div>

            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Rank</th>
                            <th>Created</th>
                            <th>Total Income</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="usersPagination"></div>
            </div>
        </div>

        <!-- Earnings Section -->
        <div class="section-container" id="earnings">
            <div class="section-header">
                <h2 class="section-title">Earnings Management</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="updateAllEarnings()">
                        <i class="fas fa-sync-alt"></i> Update All
                    </button>
                </div>
            </div>

            <div class="stats-mini" id="earningsStats">
                <!-- Mini stats will be loaded dynamically -->
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>User ID</label>
                    <input type="number" id="earningsUserId" placeholder="Filter by User ID" onkeyup="filterEarnings()">
                </div>
                <div class="filter-group">
                    <label>Earnings Type</label>
                    <select id="earningsTypeFilter" onchange="filterEarnings()">
                        <option value="">All Types</option>
                        <option value="youtube">YouTube</option>
                        <option value="tiktok">TikTok</option>
                        <option value="trivia">Trivia</option>
                        <option value="refferal">Referral</option>
                        <option value="bonus">Bonus</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Amount</label>
                    <input type="number" id="earningsMinAmount" placeholder="Min amount" onkeyup="filterEarnings()">
                </div>
                <div class="filter-group">
                    <label>Max Amount</label>
                    <input type="number" id="earningsMaxAmount" placeholder="Max amount" onkeyup="filterEarnings()">
                </div>
            </div>

            <div class="table-container">
                <table id="earningsTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>YouTube</th>
                            <th>TikTok</th>
                            <th>Trivia</th>
                            <th>Referral</th>
                            <th>Bonus</th>
                            <th>Total Earned</th>
                            <th>Withdrawn</th>
                            <th>Available</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="earningsTableBody">
                        <!-- Earnings will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="earningsPagination"></div>
            </div>
        </div>

        <!-- Withdrawals Section -->
        <div class="section-container" id="withdrawals">
            <div class="section-header">
                <h2 class="section-title">Withdrawal Requests</h2>
                <div class="section-actions">
                    <button class="btn btn-success" onclick="processSelectedWithdrawals()">
                        <i class="fas fa-check-circle"></i> Process Selected
                    </button>
                </div>
            </div>

            <div class="stats-mini" id="withdrawalStats">
                <!-- Mini stats will be loaded dynamically -->
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="withdrawalStatusFilter" onchange="filterWithdrawals()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="processing">Processing</option>
                        <option value="paid">Paid</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Payment Method</label>
                    <select id="withdrawalMethodFilter" onchange="filterWithdrawals()">
                        <option value="">All Methods</option>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Amount</label>
                    <input type="number" id="withdrawalMinAmount" placeholder="Min amount"
                        onkeyup="filterWithdrawals()">
                </div>
                <div class="filter-group">
                    <label>Max Amount</label>
                    <input type="number" id="withdrawalMaxAmount" placeholder="Max amount"
                        onkeyup="filterWithdrawals()">
                </div>
            </div>

            <div class="table-container">
                <table id="withdrawalsTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllWithdrawals"></th>
                            <th>Request ID</th>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Phone/Account</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalsTableBody">
                        <!-- Withdrawals will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="withdrawalsPagination"></div>
            </div>
        </div>

        <!-- Referrals Section -->
        <div class="section-container" id="referrals">
            <div class="section-header">
                <h2 class="section-title">Referral Network</h2>
                <button class="btn btn-primary" onclick="loadReferralStats()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div class="stats-mini" id="referralStats">
                <!-- Mini stats will be loaded dynamically -->
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Referral Levels Distribution</h3>
                    <canvas id="referralLevelsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Top Referrers</h3>
                    <canvas id="topReferrersChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <table id="referralsTable">
                    <thead>
                        <tr>
                            <th>Referral ID</th>
                            <th>Inviter</th>
                            <th>Referred User</th>
                            <th>Level</th>
                            <th>Secondary Beneficiary</th>
                            <th>Created</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="referralsTableBody">
                        <!-- Referrals will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="referralsPagination"></div>
            </div>
        </div>

        <!-- Contents Section -->
        <div class="section-container" id="contents">
            <div class="section-header">
                <h2 class="section-title">Content Management</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="showAddContentModal()">
                        <i class="fas fa-plus"></i> Add Content
                    </button>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Content Type</label>
                    <select id="contentTypeFilter" onchange="filterContents()">
                        <option value="">All Types</option>
                        <option value="youtube">YouTube</option>
                        <option value="tiktok">TikTok</option>
                        <option value="trivia">Trivia</option>
                        <option value="article">Article</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="contentSearch" placeholder="Search contents..."
                        onkeyup="searchContents(this.value)">
                </div>
            </div>

            <div class="table-container">
                <table id="contentsTable">
                    <thead>
                        <tr>
                            <th>Post ID</th>
                            <th>Content Title</th>
                            <th>Type</th>
                            <th>User ID</th>
                            <th>Total Actions</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contentsTableBody">
                        <!-- Contents will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="contentsPagination"></div>
            </div>
        </div>

        <!-- Payments Section -->
        <div class="section-container" id="payments">
            <div class="section-header">
                <h2 class="section-title">Payment Information</h2>
            </div>

            <div class="table-container">
                <table id="paymentsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Mobile Number</th>
                            <th>Payment Method</th>
                            <th>Email</th>
                            <th>Notification Pref</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Payments will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="paymentsPagination"></div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="section-container" id="statistics">
            <div class="section-header">
                <h2 class="section-title">System Statistics</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="refreshStatistics()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="export-btn" onclick="exportStatistics()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <!-- Statistics cards will be loaded dynamically -->
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Income Overview</h3>
                    <canvas id="incomeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">User Distribution</h3>
                    <canvas id="userDistributionChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <table id="statisticsTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Change</th>
                            <th>Trend</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="statisticsTableBody">
                        <!-- Statistics will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section-container" id="settings">
            <div class="section-header">
                <h2 class="section-title">System Settings</h2>
                <button class="btn btn-success" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>

            <div class="settings-container">
                <!-- Settings forms will be loaded dynamically -->
            </div>
        </div>

        <!-- Audit Log Section -->
        <div class="section-container" id="audit">
            <div class="section-header">
                <h2 class="section-title">Audit Log</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="loadAuditLog()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-danger" onclick="clearAuditLog()">
                        <i class="fas fa-trash"></i> Clear Old Logs
                    </button>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Action Type</label>
                    <select id="auditActionFilter" onchange="filterAuditLog()">
                        <option value="">All Actions</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="withdrawal">Withdrawal</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="auditStatusFilter" onchange="filterAuditLog()">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="auditDateFrom" onchange="filterAuditLog()">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="auditDateTo" onchange="filterAuditLog()">
                </div>
            </div>

            <div class="table-container">
                <table id="auditTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Auth User ID</th>
                            <th>Action</th>
                            <th>Status</th>
                            <th>Error Message</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        <!-- Audit logs will be loaded dynamically -->
                    </tbody>
                </table>
                <div class="pagination" id="auditPagination"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- User Modal -->
    <div class="modal" id="userModal" style="display: none;">
        <div class="modal-header">
            <h3 class="modal-title" id="userModalTitle">Add User</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="modalUserName" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="modalUserEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="modalUserStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rank *</label>
                        <select id="modalUserRank" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Initial Balance</label>
                    <input type="number" id="modalUserBalance" value="0">
                </div>
                <div class="form-group">
                    <label>Password (leave empty for auto-generate)</label>
                    <input type="password" id="modalUserPassword">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Save User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Content Modal -->
    <div class="modal" id="contentModal" style="display: none;">
        <div class="modal-header">
            <h3 class="modal-title" id="contentModalTitle">Add Content</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="contentForm">
                <div class="form-group">
                    <label>Content Title *</label>
                    <input type="text" id="modalContentTitle" required>
                </div>
                <div class="form-group">
                    <label>Content Type *</label>
                    <select id="modalContentType" required>
                        <option value="youtube">YouTube</option>
                        <option value="tiktok">TikTok</option>
                        <option value="trivia">Trivia</option>
                        <option value="article">Article</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User ID *</label>
                    <input type="number" id="modalContentUserId" required>
                </div>
                <div class="form-group">
                    <label>Content URL/Link</label>
                    <input type="url" id="modalContentUrl">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="modalContentDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Total Actions</label>
                    <input type="number" id="modalContentActions" value="0">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Save Content
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Withdrawal Action Modal -->
    <div class="modal" id="withdrawalActionModal" style="display: none;">
        <div class="modal-header">
            <h3 class="modal-title">Process Withdrawal</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="withdrawalActionForm">
                <div class="form-group">
                    <label>Transaction ID / Reference *</label>
                    <input type="text" id="modalTransactionId" required>
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="modalWithdrawalStatus" required>
                        <option value="paid">Mark as Paid</option>
                        <option value="processing">Mark as Processing</option>
                        <option value="rejected">Reject Withdrawal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes/Remarks</label>
                    <textarea id="modalWithdrawalNotes" rows="3"
                        placeholder="Add any notes about this transaction..."></textarea>
                </div>
                <div class="form-group">
                    <label>Send Notification to User</label>
                    <input type="checkbox" id="modalSendNotification" checked>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-check-circle"></i> Process
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Admin JavaScript
        const AdminApp = {
            supabase: null,
            currentUser: null,
            charts: {},
            currentSection: 'dashboard',
            data: {
                users: [],
                earnings: [],
                withdrawals: [],
                referrals: [],
                contents: [],
                payments: [],
                statistics: {},
                audit: []
            },
            filters: {
                users: {},
                earnings: {},
                withdrawals: {},
                contents: {},
                referrals: {},
                audit: {}
            },
            pagination: {
                users: { page: 1, limit: 10, total: 0 },
                earnings: { page: 1, limit: 10, total: 0 },
                withdrawals: { page: 1, limit: 10, total: 0 },
                referrals: { page: 1, limit: 10, total: 0 },
                contents: { page: 1, limit: 10, total: 0 },
                payments: { page: 1, limit: 10, total: 0 },
                audit: { page: 1, limit: 20, total: 0 }
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Initialize Supabase (try window.supabase first, then fall back to dynamic import)
                const supabaseUrl = 'https://kwghulqonljulmvlcfnz.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3Z2h1bHFvbmxqdWxtdmxjZm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzcyMDcsImV4cCI6MjA3OTU1MzIwN30.hebcPqAvo4B23kx4gdWuXTJhmx7p8zSHHEYSkPzPhcM';

                if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                    AdminApp.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                } else if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                    AdminApp.supabase = supabase.createClient(supabaseUrl, supabaseKey);
                } else {
                    try {
                        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
                        AdminApp.supabase = createClient(supabaseUrl, supabaseKey);
                    } catch (err) {
                        console.warn('Dynamic import of Supabase failed, attempting global fallback:', err);
                        if (typeof window.supabase !== 'undefined') {
                            AdminApp.supabase = window.supabase;
                        }
                    }
                }

                if (!AdminApp.supabase) {
                    throw new Error('Supabase client not available');
                }

                // Check authentication
                await checkAdminAuth();

                // Initialize UI
                try { setupEventListeners(); } catch (e) { console.error('setupEventListeners failed', e); }

                // Setup mobile menu
                try { setupMobileMenu(); } catch (e) { console.error('setupMobileMenu failed', e); }

                // Load dashboard data
                try { await loadDashboardData(); } catch (e) { console.error('loadDashboardData failed', e); }

                // Setup real-time subscriptions
                try { setupRealtimeSubscriptions(); } catch (e) { console.error('setupRealtimeSubscriptions failed', e); }
            } catch (err) {
                console.error('Initialization error:', err);
                const nc = document.getElementById('notificationContainer');
                if (nc) nc.innerHTML = `<div class="notification error">Initialization failed: ${String(err)}</div>`;
            }
        });

        // Setup mobile menu functionality
        function setupMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarClose = document.getElementById('sidebarClose');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const menuItems = document.querySelectorAll('.menu-item');

            // Toggle sidebar
            if (mobileMenuToggle && sidebar && mobileMenuOverlay) {
                mobileMenuToggle.addEventListener('click', function () {
                    sidebar.classList.add('active');
                    mobileMenuOverlay.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });

                // Close sidebar
                if (sidebarClose) sidebarClose.addEventListener('click', closeMobileMenu);
                mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            }

            // Close sidebar when clicking menu items on mobile
            if (menuItems && menuItems.length) {
                menuItems.forEach(item => {
                    item.addEventListener('click', function () {
                        if (window.innerWidth <= 768) {
                            closeMobileMenu();
                        }
                    });
                });
            }

            // Close sidebar with escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeMobileMenu();
                }
            });

            // Close mobile menu function
            function closeMobileMenu() {
                sidebar.classList.remove('active');
                mobileMenuOverlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            // Resize handler
            window.addEventListener('resize', function () {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    mobileMenuOverlay.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Check if user is admin
        async function checkAdminAuth() {
            showLoading();

            try {
                const { data: { user }, error } = await AdminApp.supabase.auth.getUser();

                if (error) {
                    throw error;
                }

                if (!user) {
                    redirectToLogin();
                    return;
                }

                // Check if user has admin role (match by uuid or email as fallback)
                const identifierEmail = user.email || '';
                const identifierUuid = user.id;

                const { data: userData, error: userError } = await AdminApp.supabase
                    .from('users')
                    .select('rank, uuid, email_address')
                    .or(`uuid.eq.${identifierUuid},email_address.eq.${identifierEmail}`)
                    .maybeSingle();

                if (userError || !userData || userData.rank !== 'admin') {
                    showNotification('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => redirectToLogin(), 2000);
                    return;
                }

                AdminApp.currentUser = user;

                // Update UI with admin info (guard element existence)
                const adminAvatarEl = document.getElementById('adminAvatar');
                if (adminAvatarEl) {
                    adminAvatarEl.textContent = user.email ? user.email.charAt(0).toUpperCase() : 'A';
                }

                hideLoading();

            } catch (error) {
                console.error('Auth error:', error);
                showNotification('Authentication error: ' + error.message, 'error');
                setTimeout(() => redirectToLogin(), 3000);
            }
        }

        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function () {
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function () {
                    await logout();
                });
            }

            // Quick actions
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const action = this.dataset.action;
                    handleQuickAction(action);
                });
            });

            // Select all withdrawals checkbox
            const selectAllWithdrawalsEl = document.getElementById('selectAllWithdrawals');
            if (selectAllWithdrawalsEl) {
                selectAllWithdrawalsEl.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll('.withdrawal-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            }

            // Modal overlay click
            const modalOverlayEl = document.getElementById('modalOverlay');
            if (modalOverlayEl) modalOverlayEl.addEventListener('click', closeModal);

            // Form submissions
            const userFormEl = document.getElementById('userForm');
            if (userFormEl) userFormEl.addEventListener('submit', handleUserFormSubmit);

            const contentFormEl = document.getElementById('contentForm');
            if (contentFormEl) contentFormEl.addEventListener('submit', handleContentFormSubmit);

            const withdrawalActionFormEl = document.getElementById('withdrawalActionForm');
            if (withdrawalActionFormEl) withdrawalActionFormEl.addEventListener('submit', handleWithdrawalActionSubmit);
        }

        // Switch between sections
        function switchSection(section) {
            // Update menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            // Update content sections
            document.querySelectorAll('.section-container').forEach(container => {
                container.classList.remove('active');
                if (container.id === section) {
                    container.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                'dashboard': 'Admin Dashboard',
                'users': 'User Management',
                'earnings': 'Earnings Management',
                'withdrawals': 'Withdrawal Requests',
                'referrals': 'Referral Network',
                'contents': 'Content Management',
                'payments': 'Payment Information',
                'statistics': 'System Statistics',
                'settings': 'System Settings',
                'audit': 'Audit Log'
            };

            const descriptions = {
                'dashboard': 'Overview and analytics',
                'users': 'Manage user accounts',
                'earnings': 'View and manage user earnings',
                'withdrawals': 'Process withdrawal requests',
                'referrals': 'Monitor referral network',
                'contents': 'Manage platform contents',
                'payments': 'View payment information',
                'statistics': 'System-wide statistics',
                'settings': 'Configure system settings',
                'audit': 'System activity log'
            };

            const pageTitleEl = document.getElementById('pageTitle');
            if (pageTitleEl) pageTitleEl.textContent = titles[section] || 'Admin';

            const pageDescriptionEl = document.getElementById('pageDescription');
            if (pageDescriptionEl) pageDescriptionEl.textContent = descriptions[section] || '';

            AdminApp.currentSection = section;

            // Load section-specific data
            loadSectionData(section);
        }

        // Load section data
        async function loadSectionData(section) {
            switch (section) {
                case 'dashboard':
                    await loadDashboardData();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'earnings':
                    await loadEarnings();
                    break;
                case 'withdrawals':
                    await loadWithdrawals();
                    break;
                case 'referrals':
                    await loadReferrals();
                    break;
                case 'contents':
                    await loadContents();
                    break;
                case 'payments':
                    await loadPayments();
                    break;
                case 'statistics':
                    await loadStatistics();
                    break;
                case 'settings':
                    await loadSettings();
                    break;
                case 'audit':
                    await loadAuditLog();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading();

            try {
                // Load all stats in parallel
                const [
                    usersCount,
                    earningsStats,
                    withdrawalStats,
                    referralStats,
                    recentWithdrawals,
                    recentActivities
                ] = await Promise.all([
                    getUsersCount(),
                    getEarningsStats(),
                    getWithdrawalStats(),
                    getReferralStats(),
                    getRecentWithdrawals(),
                    getRecentActivities()
                ]);

                // Update stats grid
                updateStatsGrid(usersCount, earningsStats, withdrawalStats, referralStats);

                // Load charts
                loadCharts();

                // Update recent activities
                updateRecentActivities(recentActivities);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Get users count
        async function getUsersCount() {
            const { count, error } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true });

            if (error) throw error;

            // Get active users
            const { count: activeCount, error: activeError } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'active');

            if (activeError) throw activeError;

            // Get new users today
            const today = new Date().toISOString().split('T')[0];
            const { count: newTodayCount, error: newTodayError } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', today);

            if (newTodayError) throw newTodayError;

            return {
                total: count,
                active: activeCount,
                newToday: newTodayCount
            };
        }

        // Get earnings stats
        async function getEarningsStats() {
            // Get total all_time_earn
            const { data: totalEarnings, error: totalError } = await AdminApp.supabase
                .from('earnings')
                .select('all_time_earn');

            if (totalError) throw totalError;

            const total = totalEarnings.reduce((sum, e) => sum + (e.all_time_earn || 0), 0);

            // Get total withdrawn
            const { data: totalWithdrawn, error: withdrawnError } = await AdminApp.supabase
                .from('earnings')
                .select('total_withdrawn');

            if (withdrawnError) throw withdrawnError;

            const withdrawn = totalWithdrawn.reduce((sum, e) => sum + (e.total_withdrawn || 0), 0);

            // Get available (total - withdrawn)
            const available = total - withdrawn;

            // Get today's earnings
            const today = new Date().toISOString().split('T')[0];
            const { data: todayEarnings, error: todayError } = await AdminApp.supabase
                .from('earnings')
                .select('*')
                .gte('created_at', today);

            if (todayError) throw todayError;

            const todayTotal = todayEarnings.reduce((sum, e) => sum + (e.all_time_earn || 0), 0);

            return {
                total,
                withdrawn,
                available,
                today: todayTotal
            };
        }

        // Get withdrawal stats
        async function getWithdrawalStats() {
            // Get pending withdrawals
            const { data: pending, error: pendingError } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select('amount')
                .eq('status', 'pending');

            if (pendingError) throw pendingError;

            const pendingTotal = pending.reduce((sum, w) => sum + (w.amount || 0), 0);

            // Get approved withdrawals
            const { data: approved, error: approvedError } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select('amount')
                .eq('status', 'approved');

            if (approvedError) throw approvedError;

            const approvedTotal = approved.reduce((sum, w) => sum + (w.amount || 0), 0);

            // Get total withdrawals
            const { data: allWithdrawals, error: allError } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select('amount, status');

            if (allError) throw allError;

            const totalWithdrawn = allWithdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);

            // Get today's withdrawals
            const today = new Date().toISOString().split('T')[0];
            const { data: todayWithdrawals, error: todayError } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select('amount')
                .gte('created_at', today);

            if (todayError) throw todayError;

            const todayTotal = todayWithdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);

            return {
                pending: pendingTotal,
                approved: approvedTotal,
                total: totalWithdrawn,
                today: todayTotal
            };
        }

        // Get referral stats
        async function getReferralStats() {
            // Get total referrals
            const { count: totalReferrals, error: totalError } = await AdminApp.supabase
                .from('refferals')
                .select('*', { count: 'exact', head: true });

            if (totalError) throw totalError;

            // Get L1 referrals
            const { count: l1Referrals, error: l1Error } = await AdminApp.supabase
                .from('refferals')
                .select('*', { count: 'exact', head: true })
                .not('inviter_id', 'is', null);

            if (l1Error) throw l1Error;

            // Get L2 referrals
            const { count: l2Referrals, error: l2Error } = await AdminApp.supabase
                .from('refferals')
                .select('*', { count: 'exact', head: true })
                .not('secondary_benefit', 'is', null);

            if (l2Error) throw l2Error;

            // Get today's referrals
            const today = new Date().toISOString().split('T')[0];
            const { count: todayReferrals, error: todayError } = await AdminApp.supabase
                .from('refferals')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', today);

            if (todayError) throw todayError;

            return {
                total: totalReferrals,
                l1: l1Referrals,
                l2: l2Referrals,
                today: todayReferrals
            };
        }

        // Get recent withdrawals
        async function getRecentWithdrawals() {
            const { data, error } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select(`
                    *,
                    users (
                        user_name,
                        email_address
                    )
                `)
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) throw error;
            return data || [];
        }

        // Get recent activities
        async function getRecentActivities() {
            const { data, error } = await AdminApp.supabase
                .from('user_sync_audit')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) throw error;
            return data || [];
        }

        // Update stats grid
        function updateStatsGrid(users, earnings, withdrawals, referrals) {
            const statsGrid = document.getElementById('statsGrid');

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Total Users</h3>
                            <p class="stat-label">Active: ${users.active}</p>
                        </div>
                        <div class="stat-icon icon-users">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value">${users.total.toLocaleString()}</div>
                    <div class="stat-change change-positive">
                        <i class="fas fa-arrow-up"></i> ${users.newToday} today
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Total Income</h3>
                            <p class="stat-label">Available: UGX ${earnings.available.toLocaleString()}</p>
                        </div>
                        <div class="stat-icon icon-income">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${earnings.total.toLocaleString()}</div>
                    <div class="stat-change change-positive">
                        <i class="fas fa-arrow-up"></i> UGX ${earnings.today.toLocaleString()} today
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Withdrawals</h3>
                            <p class="stat-label">Pending: UGX ${withdrawals.pending.toLocaleString()}</p>
                        </div>
                        <div class="stat-icon icon-withdrawals">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${withdrawals.total.toLocaleString()}</div>
                    <div class="stat-change ${withdrawals.today > 0 ? 'change-positive' : 'change-negative'}">
                        <i class="fas fa-${withdrawals.today > 0 ? 'arrow-up' : 'arrow-down'}"></i> 
                        UGX ${withdrawals.today.toLocaleString()} today
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Pending Withdrawals</h3>
                            <p class="stat-label">Require action</p>
                        </div>
                        <div class="stat-icon icon-pending">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${withdrawals.pending.toLocaleString()}</div>
                    <div class="stat-change change-negative">
                        <i class="fas fa-exclamation-circle"></i> Needs processing
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Total Earnings</h3>
                            <p class="stat-label">All users combined</p>
                        </div>
                        <div class="stat-icon icon-earnings">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${earnings.total.toLocaleString()}</div>
                    <div class="stat-change change-positive">
                        <i class="fas fa-arrow-up"></i> UGX ${earnings.today.toLocaleString()} today
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Referral Network</h3>
                            <p class="stat-label">L1: ${referrals.l1} | L2: ${referrals.l2}</p>
                        </div>
                        <div class="stat-icon icon-referrals">
                            <i class="fas fa-network-wired"></i>
                        </div>
                    </div>
                    <div class="stat-value">${referrals.total.toLocaleString()}</div>
                    <div class="stat-change change-positive">
                        <i class="fas fa-arrow-up"></i> ${referrals.today} today
                    </div>
                </div>
            `;
        }

        // Load charts
        function loadCharts() {
            // Destroy existing charts
            Object.values(AdminApp.charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            AdminApp.charts = {};

            // Load user growth chart
            loadUserGrowthChart();

            // Load earnings chart
            loadEarningsChart();

            // Load withdrawal chart
            loadWithdrawalChart();

            // Load activity chart
            loadActivityChart();
        }

            async function loadUserGrowthChart() {
                const userGrowthCanvas = document.getElementById('userGrowthChart');
                if (!userGrowthCanvas) return;
                const ctx = userGrowthCanvas.getContext('2d');

            // Get last 7 days data
            const days = 7;
            const dates = [];
            const counts = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dates.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                const { count, error } = await AdminApp.supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', dateStr + 'T00:00:00')
                    .lte('created_at', dateStr + 'T23:59:59');

                counts.push(error ? 0 : count);
            }

            AdminApp.charts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'New Users',
                        data: counts,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        async function loadEarningsChart() {
            const earningsCanvas = document.getElementById('earningsChart');
            if (!earningsCanvas) return;
            const ctx = earningsCanvas.getContext('2d');

            // Get earnings by type
            const { data: earnings, error } = await AdminApp.supabase
                .from('earnings')
                .select('youtube, tiktok, trivia, refferal, bonus');

            if (error) {
                console.error('Error loading earnings:', error);
                return;
            }

            const totals = {
                youtube: 0,
                tiktok: 0,
                trivia: 0,
                refferal: 0,
                bonus: 0
            };

            earnings.forEach(e => {
                totals.youtube += e.youtube || 0;
                totals.tiktok += e.tiktok || 0;
                totals.trivia += e.trivia || 0;
                totals.refferal += e.refferal || 0;
                totals.bonus += e.bonus || 0;
            });

            AdminApp.charts.earnings = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['YouTube', 'TikTok', 'Trivia', 'Referral', 'Bonus'],
                    datasets: [{
                        data: [
                            totals.youtube,
                            totals.tiktok,
                            totals.trivia,
                            totals.refferal,
                            totals.bonus
                        ],
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#2ecc71',
                            '#9b59b6',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadWithdrawalChart() {
            const withdrawalCanvas = document.getElementById('withdrawalChart');
            if (!withdrawalCanvas) return;
            const ctx = withdrawalCanvas.getContext('2d');

            // Get withdrawal counts by status
            const { data: withdrawals, error } = await AdminApp.supabase
                .from('withdrawal_requests')
                .select('status');

            if (error) {
                console.error('Error loading withdrawals:', error);
                return;
            }

            const statusCounts = {
                pending: 0,
                approved: 0,
                processing: 0,
                paid: 0,
                rejected: 0
            };

            withdrawals.forEach(w => {
                if (statusCounts[w.status] !== undefined) {
                    statusCounts[w.status]++;
                }
            });

            AdminApp.charts.withdrawals = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'Approved', 'Processing', 'Paid', 'Rejected'],
                    datasets: [{
                        label: 'Count',
                        data: [
                            statusCounts.pending,
                            statusCounts.approved,
                            statusCounts.processing,
                            statusCounts.paid,
                            statusCounts.rejected
                        ],
                        backgroundColor: [
                            '#f39c12',
                            '#3498db',
                            '#9b59b6',
                            '#2ecc71',
                            '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        async function loadActivityChart() {
            const activityCanvas = document.getElementById('activityChart');
            if (!activityCanvas) return;
            const ctx = activityCanvas.getContext('2d');

            // Get last 5 days activity
            const days = 5;
            const dates = [];
            const activityCounts = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const { count, error } = await AdminApp.supabase
                    .from('user_sync_audit')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', dateStr + 'T00:00:00')
                    .lte('created_at', dateStr + 'T23:59:59');

                activityCounts.push(error ? 0 : count);
            }

            AdminApp.charts.activity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Activities',
                        data: activityCounts,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update recent activities
        function updateRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            if (!container) return;

            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">No recent activities</p>';
                return;
            }

            let html = '<table style="width: 100%;"><thead><tr><th>Time</th><th>Action</th><th>Status</th><th>Details</th></tr></thead><tbody>';

            activities.forEach(activity => {
                const time = new Date(activity.created_at).toLocaleTimeString();
                const statusClass = activity.status === 'success' ? 'status-success' : 'status-error';
                const statusText = activity.status === 'success' ? 'Success' : 'Failed';

                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${activity.action}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${activity.error_message || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Load users
        async function loadUsers() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.users;
                const offset = (page - 1) * limit;

                let query = AdminApp.supabase
                    .from('users')
                    .select('*', { count: 'exact' });

                // Apply filters
                if (AdminApp.filters.users.status) {
                    query = query.eq('status', AdminApp.filters.users.status);
                }

                if (AdminApp.filters.users.rank) {
                    query = query.eq('rank', AdminApp.filters.users.rank);
                }

                if (AdminApp.filters.users.dateFrom) {
                    query = query.gte('created_at', AdminApp.filters.users.dateFrom);
                }

                if (AdminApp.filters.users.dateTo) {
                    query = query.lte('created_at', AdminApp.filters.users.dateTo);
                }

                const { data, count, error } = await query
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.users = data || [];
                AdminApp.pagination.users.total = count || 0;

                updateUsersTable();
                updateUsersPagination();

            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Error loading users: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update users table
        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;

            if (!AdminApp.data.users.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.users.forEach(user => {
                const statusClass = user.status === 'active' ? 'status-active' :
                    user.status === 'inactive' ? 'status-inactive' : 'status-pending';

                const created = new Date(user.created_at).toLocaleDateString();

                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.user_name || '-'}</td>
                        <td>${user.email_address || '-'}</td>
                        <td><span class="${statusClass}">${user.status || 'N/A'}</span></td>
                        <td><span class="status-badge">${user.rank || 'user'}</span></td>
                        <td>${created}</td>
                        <td>UGX ${(user.total_income || 0).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view-btn" onclick="viewUser(${user.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit-btn" onclick="editUser(${user.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.rank !== 'admin' ? `
                                <button class="action-btn delete-btn" onclick="deleteUser(${user.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update users pagination
        function updateUsersPagination() {
            const { page, limit, total } = AdminApp.pagination.users;
            const totalPages = Math.ceil(total / limit);

            const container = document.getElementById('usersPagination');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            if (page > 1) {
                html += `<button class="page-btn" onclick="changeUsersPage(${page - 1})">Previous</button>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === page) {
                    html += `<button class="page-btn active">${i}</button>`;
                } else if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                    html += `<button class="page-btn" onclick="changeUsersPage(${i})">${i}</button>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += `<span class="page-btn">...</span>`;
                }
            }

            // Next button
            if (page < totalPages) {
                html += `<button class="page-btn" onclick="changeUsersPage(${page + 1})">Next</button>`;
            }

            container.innerHTML = html;
        }

        // Change users page
        function changeUsersPage(newPage) {
            AdminApp.pagination.users.page = newPage;
            loadUsers();
        }

        // Filter users
        function filterUsers() {
            AdminApp.filters.users = {
                status: document.getElementById('userStatusFilter').value,
                rank: document.getElementById('userRankFilter').value,
                dateFrom: document.getElementById('userDateFrom').value,
                dateTo: document.getElementById('userDateTo').value
            };

            AdminApp.pagination.users.page = 1;
            loadUsers();
        }

        // Search users
        function searchUsers(query) {
            // Implement search logic
            console.log('Searching users:', query);
        }

        // Show add user modal
        function showAddUserModal() {
            const userModalTitleEl = document.getElementById('userModalTitle');
            if (userModalTitleEl) userModalTitleEl.textContent = 'Add User';

            const userFormEl = document.getElementById('userForm');
            if (userFormEl) {
                try { userFormEl.reset(); } catch (e) {}
                userFormEl.dataset.userId = '';
            }

            showModal('userModal');
        }

        // Handle user form submission
        async function handleUserFormSubmit(e) {
            e.preventDefault();

            const userId = e.target.dataset.userId;
            const username = document.getElementById('modalUserName').value;
            const email = document.getElementById('modalUserEmail').value;
            const status = document.getElementById('modalUserStatus').value;
            const rank = document.getElementById('modalUserRank').value;
            const balance = document.getElementById('modalUserBalance').value;
            const password = document.getElementById('modalUserPassword').value;

            try {
                showLoading();

                if (userId) {
                    // Update existing user
                    const { error } = await AdminApp.supabase
                        .from('users')
                        .update({
                            user_name: username,
                            email_address: email,
                            status: status,
                            rank: rank,
                            total_income: parseInt(balance)
                        })
                        .eq('id', userId);

                    if (error) throw error;

                    showNotification('User updated successfully', 'success');
                } else {
                    // Create new user
                    // First create auth user
                    const { data: authData, error: authError } = await AdminApp.supabase.auth.admin
                        .createUser({
                            email: email,
                            password: password || generatePassword(),
                            email_confirm: true
                        });

                    if (authError) throw authError;

                    // Then create user in public.users
                    const { error: userError } = await AdminApp.supabase
                        .from('users')
                        .insert({
                            user_name: username,
                            email_address: email,
                            status: status,
                            rank: rank,
                            total_income: parseInt(balance),
                            uuid: authData.user.id
                        });

                    if (userError) throw userError;

                    showNotification('User created successfully', 'success');
                }

                closeModal();
                loadUsers();

            } catch (error) {
                console.error('Error saving user:', error);
                showNotification('Error saving user: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // View user details
        async function viewUser(userId) {
            try {
                showLoading();

                const { data: user, error } = await AdminApp.supabase
                    .from('users')
                    .select(`
                        *,
                        earnings (*),
                        withdrawal_requests (*),
                        refferals (*)
                    `)
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // Show user details in a modal
                const modalContent = `
                    <h3>User Details: ${user.user_name}</h3>
                    <div style="margin: 20px 0;">
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Email:</strong> ${user.email_address}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Rank:</strong> ${user.rank}</p>
                        <p><strong>Total Income:</strong> UGX ${user.total_income?.toLocaleString()}</p>
                        <p><strong>Created:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                    </div>
                    
                    ${user.earnings ? `
                    <h4>Earnings</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <p>YouTube: UGX ${user.earnings.youtube?.toLocaleString() || 0}</p>
                        <p>TikTok: UGX ${user.earnings.tiktok?.toLocaleString() || 0}</p>
                        <p>Trivia: UGX ${user.earnings.trivia?.toLocaleString() || 0}</p>
                        <p>Referral: UGX ${user.earnings.refferal?.toLocaleString() || 0}</p>
                        <p>Bonus: UGX ${user.earnings.bonus?.toLocaleString() || 0}</p>
                        <p><strong>Total Earned:</strong> UGX ${user.earnings.all_time_earn?.toLocaleString() || 0}</p>
                    </div>
                    ` : ''}
                    
                    ${user.withdrawal_requests?.length ? `
                    <h4>Recent Withdrawals</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${user.withdrawal_requests.map(w => `
                            <div style="border-bottom: 1px solid #eee; padding: 5px 0;">
                                UGX ${w.amount?.toLocaleString()} - ${w.status} - ${new Date(w.created_at).toLocaleDateString()}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="editUser(${userId})" class="btn btn-primary" style="margin-right: 10px;">
                            <i class="fas fa-edit"></i> Edit User
                        </button>
                        <button onclick="closeModal()" class="btn">
                            Close
                        </button>
                    </div>
                `;

                showCustomModal('User Details', modalContent);

            } catch (error) {
                console.error('Error viewing user:', error);
                showNotification('Error loading user details', 'error');
            } finally {
                hideLoading();
            }
        }

        // Edit user
        async function editUser(userId) {
            try {
                showLoading();

                const { data: user, error } = await AdminApp.supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                const userModalTitleEl = document.getElementById('userModalTitle');
                if (userModalTitleEl) userModalTitleEl.textContent = 'Edit User';

                const modalUserNameEl = document.getElementById('modalUserName');
                if (modalUserNameEl) modalUserNameEl.value = user.user_name || '';

                const modalUserEmailEl = document.getElementById('modalUserEmail');
                if (modalUserEmailEl) modalUserEmailEl.value = user.email_address || '';

                const modalUserStatusEl = document.getElementById('modalUserStatus');
                if (modalUserStatusEl) modalUserStatusEl.value = user.status || 'active';

                const modalUserRankEl = document.getElementById('modalUserRank');
                if (modalUserRankEl) modalUserRankEl.value = user.rank || 'user';

                const modalUserBalanceEl = document.getElementById('modalUserBalance');
                if (modalUserBalanceEl) modalUserBalanceEl.value = user.total_income || 0;

                const modalUserPasswordEl = document.getElementById('modalUserPassword');
                if (modalUserPasswordEl) {
                    modalUserPasswordEl.value = '';
                    modalUserPasswordEl.placeholder = 'Leave empty to keep current';
                }

                const userFormEl = document.getElementById('userForm');
                if (userFormEl) userFormEl.dataset.userId = userId;

                showModal('userModal');

            } catch (error) {
                console.error('Error loading user:', error);
                showNotification('Error loading user data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading();

                // First get user's UUID
                const { data: user, error: userError } = await AdminApp.supabase
                    .from('users')
                    .select('uuid')
                    .eq('id', userId)
                    .single();

                if (userError) throw userError;

                // Delete from auth.users (admin only)
                const { error: authError } = await AdminApp.supabase.auth.admin
                    .deleteUser(user.uuid);

                if (authError) throw authError;

                // Delete from public.users (cascade will handle other tables)
                const { error: deleteError } = await AdminApp.supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (deleteError) throw deleteError;

                showNotification('User deleted successfully', 'success');
                loadUsers();

            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Error deleting user: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Load earnings
        async function loadEarnings() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.earnings;
                const offset = (page - 1) * limit;

                let query = AdminApp.supabase
                    .from('earnings')
                    .select(`
                        *,
                        users (
                            user_name,
                            email_address
                        )
                    `, { count: 'exact' });

                // Apply filters
                if (AdminApp.filters.earnings.userId) {
                    query = query.eq('id', AdminApp.filters.earnings.userId);
                }

                if (AdminApp.filters.earnings.minAmount) {
                    query = query.gte('all_time_earn', AdminApp.filters.earnings.minAmount);
                }

                if (AdminApp.filters.earnings.maxAmount) {
                    query = query.lte('all_time_earn', AdminApp.filters.earnings.maxAmount);
                }

                const { data, count, error } = await query
                    .order('all_time_earn', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.earnings = data || [];
                AdminApp.pagination.earnings.total = count || 0;

                updateEarningsTable();
                updateEarningsPagination();
                updateEarningsStatsMini();

            } catch (error) {
                console.error('Error loading earnings:', error);
                showNotification('Error loading earnings: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update earnings table
        function updateEarningsTable() {
            const tbody = document.getElementById('earningsTableBody');

            if (!AdminApp.data.earnings.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #666;">
                            No earnings data found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.earnings.forEach(earning => {
                const user = earning.users;
                const available = (earning.all_time_earn || 0) - (earning.total_withdrawn || 0);

                html += `
                    <tr>
                        <td>${earning.id}</td>
                        <td>${user?.user_name || 'N/A'}</td>
                        <td>UGX ${(earning.youtube || 0).toLocaleString()}</td>
                        <td>UGX ${(earning.tiktok || 0).toLocaleString()}</td>
                        <td>UGX ${(earning.trivia || 0).toLocaleString()}</td>
                        <td>UGX ${(earning.refferal || 0).toLocaleString()}</td>
                        <td>UGX ${(earning.bonus || 0).toLocaleString()}</td>
                        <td><strong>UGX ${(earning.all_time_earn || 0).toLocaleString()}</strong></td>
                        <td>UGX ${(earning.total_withdrawn || 0).toLocaleString()}</td>
                        <td>UGX ${available.toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editEarning(${earning.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn view-btn" onclick="viewUserEarnings(${earning.id})" title="View Details">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update earnings stats mini
        async function updateEarningsStatsMini() {
            const container = document.getElementById('earningsStats');

            // Calculate totals
            const totals = {
                youtube: 0,
                tiktok: 0,
                trivia: 0,
                refferal: 0,
                bonus: 0,
                all_time: 0,
                withdrawn: 0,
                available: 0
            };

            AdminApp.data.earnings.forEach(e => {
                totals.youtube += e.youtube || 0;
                totals.tiktok += e.tiktok || 0;
                totals.trivia += e.trivia || 0;
                totals.refferal += e.refferal || 0;
                totals.bonus += e.bonus || 0;
                totals.all_time += e.all_time_earn || 0;
                totals.withdrawn += e.total_withdrawn || 0;
            });

            totals.available = totals.all_time - totals.withdrawn;

            container.innerHTML = `
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #3498db;">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>UGX ${totals.youtube.toLocaleString()}</h4>
                        <p>YouTube Earnings</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #e74c3c;">
                        <i class="fab fa-tiktok"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>UGX ${totals.tiktok.toLocaleString()}</h4>
                        <p>TikTok Earnings</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #2ecc71;">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>UGX ${totals.trivia.toLocaleString()}</h4>
                        <p>Trivia Earnings</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #9b59b6;">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>UGX ${totals.refferal.toLocaleString()}</h4>
                        <p>Referral Earnings</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #f39c12;">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>UGX ${totals.bonus.toLocaleString()}</h4>
                        <p>Bonus Earnings</p>
                    </div>
                </div>
            `;
        }

        // Filter earnings
        function filterEarnings() {
            AdminApp.filters.earnings = {
                userId: document.getElementById('earningsUserId').value,
                minAmount: document.getElementById('earningsMinAmount').value,
                maxAmount: document.getElementById('earningsMaxAmount').value
            };

            AdminApp.pagination.earnings.page = 1;
            loadEarnings();
        }

        // Load withdrawals
        async function loadWithdrawals() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.withdrawals;
                const offset = (page - 1) * limit;

                let query = AdminApp.supabase
                    .from('withdrawal_requests')
                    .select(`
                        *,
                        users (
                            user_name,
                            email_address
                        )
                    `, { count: 'exact' });

                // Apply filters
                if (AdminApp.filters.withdrawals.status) {
                    query = query.eq('status', AdminApp.filters.withdrawals.status);
                }

                if (AdminApp.filters.withdrawals.method) {
                    query = query.eq('payment_method', AdminApp.filters.withdrawals.method);
                }

                if (AdminApp.filters.withdrawals.minAmount) {
                    query = query.gte('amount', AdminApp.filters.withdrawals.minAmount);
                }

                if (AdminApp.filters.withdrawals.maxAmount) {
                    query = query.lte('amount', AdminApp.filters.withdrawals.maxAmount);
                }

                const { data, count, error } = await query
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.withdrawals = data || [];
                AdminApp.pagination.withdrawals.total = count || 0;

                updateWithdrawalsTable();
                updateWithdrawalsPagination();
                updateWithdrawalStatsMini();

            } catch (error) {
                console.error('Error loading withdrawals:', error);
                showNotification('Error loading withdrawals: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update withdrawals table
        function updateWithdrawalsTable() {
            const tbody = document.getElementById('withdrawalsTableBody');

            if (!AdminApp.data.withdrawals.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                            No withdrawal requests found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.withdrawals.forEach(withdrawal => {
                const user = withdrawal.users;
                const statusClass = `status-${withdrawal.status}`;
                const created = new Date(withdrawal.created_at).toLocaleDateString();

                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="withdrawal-checkbox" 
                                   value="${withdrawal.request_id}" 
                                   ${withdrawal.status === 'pending' ? '' : 'disabled'}>
                        </td>
                        <td>${withdrawal.request_id}</td>
                        <td>${withdrawal.id}</td>
                        <td>${user?.user_name || 'N/A'}</td>
                        <td>UGX ${(withdrawal.amount || 0).toLocaleString()}</td>
                        <td>${withdrawal.payment_method || 'N/A'}</td>
                        <td>${withdrawal.phone_number || withdrawal.email || 'N/A'}</td>
                        <td><span class="${statusClass}">${withdrawal.status || 'pending'}</span></td>
                        <td>${created}</td>
                        <td>
                            <div class="action-buttons">
                                ${withdrawal.status === 'pending' ? `
                                <button class="action-btn approve-btn" onclick="processWithdrawal(${withdrawal.request_id}, 'approve')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn reject-btn" onclick="processWithdrawal(${withdrawal.request_id}, 'reject')" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                                ` : ''}
                                <button class="action-btn view-btn" onclick="viewWithdrawal(${withdrawal.request_id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update withdrawal stats mini
        async function updateWithdrawalStatsMini() {
            const container = document.getElementById('withdrawalStats');

            // Calculate stats
            const stats = {
                pending: { count: 0, amount: 0 },
                approved: { count: 0, amount: 0 },
                processing: { count: 0, amount: 0 },
                paid: { count: 0, amount: 0 },
                total: { count: 0, amount: 0 }
            };

            AdminApp.data.withdrawals.forEach(w => {
                const status = w.status;
                if (stats[status]) {
                    stats[status].count++;
                    stats[status].amount += w.amount || 0;
                }
                stats.total.count++;
                stats.total.amount += w.amount || 0;
            });

            container.innerHTML = `
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #f39c12;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>${stats.pending.count}</h4>
                        <p>Pending (UGX ${stats.pending.amount.toLocaleString()})</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #3498db;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>${stats.approved.count}</h4>
                        <p>Approved (UGX ${stats.approved.amount.toLocaleString()})</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #9b59b6;">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>${stats.processing.count}</h4>
                        <p>Processing (UGX ${stats.processing.amount.toLocaleString()})</p>
                    </div>
                </div>
                <div class="stat-mini-card">
                    <div class="stat-mini-icon" style="background: #2ecc71;">
                        <i class="fas fa-money-check"></i>
                    </div>
                    <div class="stat-mini-info">
                        <h4>${stats.paid.count}</h4>
                        <p>Paid (UGX ${stats.paid.amount.toLocaleString()})</p>
                    </div>
                </div>
            `;
        }

        // Filter withdrawals
        function filterWithdrawals() {
            AdminApp.filters.withdrawals = {
                status: document.getElementById('withdrawalStatusFilter').value,
                method: document.getElementById('withdrawalMethodFilter').value,
                minAmount: document.getElementById('withdrawalMinAmount').value,
                maxAmount: document.getElementById('withdrawalMaxAmount').value
            };

            AdminApp.pagination.withdrawals.page = 1;
            loadWithdrawals();
        }

        // Process withdrawal
        async function processWithdrawal(requestId, action) {
            const newStatus = action === 'approve' ? 'approved' : 'rejected';

            if (!confirm(`Are you sure you want to ${action} this withdrawal request?`)) {
                return;
            }

            try {
                showLoading();

                const { error } = await AdminApp.supabase
                    .from('withdrawal_requests')
                    .update({ status: newStatus })
                    .eq('request_id', requestId);

                if (error) throw error;

                showNotification(`Withdrawal ${action}d successfully`, 'success');
                loadWithdrawals();

            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showNotification('Error processing withdrawal: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Process selected withdrawals
        async function processSelectedWithdrawals() {
            const checkboxes = document.querySelectorAll('.withdrawal-checkbox:checked');

            if (checkboxes.length === 0) {
                showNotification('Please select at least one withdrawal to process', 'warning');
                return;
            }

            const requestIds = Array.from(checkboxes).map(cb => cb.value);

            // Show action modal
            document.getElementById('withdrawalActionForm').dataset.requestIds = requestIds.join(',');
            showModal('withdrawalActionModal');
        }

        // Handle withdrawal action form
        async function handleWithdrawalActionSubmit(e) {
            e.preventDefault();

            const requestIds = e.target.dataset.requestIds.split(',');
            const transactionId = document.getElementById('modalTransactionId').value;
            const status = document.getElementById('modalWithdrawalStatus').value;
            const notes = document.getElementById('modalWithdrawalNotes').value;
            const sendNotification = document.getElementById('modalSendNotification').checked;

            try {
                showLoading();

                // Update all selected withdrawals
                const { error } = await AdminApp.supabase
                    .from('withdrawal_requests')
                    .update({
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .in('request_id', requestIds);

                if (error) throw error;

                // Update earnings table for each user
                for (const requestId of requestIds) {
                    // Get withdrawal details
                    const { data: withdrawal, error: withdrawalError } = await AdminApp.supabase
                        .from('withdrawal_requests')
                        .select('id, amount')
                        .eq('request_id', requestId)
                        .single();

                    if (withdrawalError) continue;

                    // Update user's earnings
                    const { data: earnings, error: earningsError } = await AdminApp.supabase
                        .from('earnings')
                        .select('total_withdrawn')
                        .eq('id', withdrawal.id)
                        .single();

                    if (earningsError) continue;

                    const newTotal = (earnings.total_withdrawn || 0) + (withdrawal.amount || 0);

                    await AdminApp.supabase
                        .from('earnings')
                        .update({ total_withdrawn: newTotal })
                        .eq('id', withdrawal.id);
                }

                showNotification(`Processed ${requestIds.length} withdrawal(s) successfully`, 'success');

                closeModal();
                loadWithdrawals();

            } catch (error) {
                console.error('Error processing withdrawals:', error);
                showNotification('Error processing withdrawals: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // View withdrawal details
        async function viewWithdrawal(requestId) {
            try {
                showLoading();

                const { data: withdrawal, error } = await AdminApp.supabase
                    .from('withdrawal_requests')
                    .select(`
                        *,
                        users (
                            user_name,
                            email_address
                        )
                    `)
                    .eq('request_id', requestId)
                    .single();

                if (error) throw error;

                const user = withdrawal.users;
                const created = new Date(withdrawal.created_at).toLocaleString();

                const modalContent = `
                    <h3>Withdrawal Details</h3>
                    <div style="margin: 20px 0;">
                        <p><strong>Request ID:</strong> ${withdrawal.request_id}</p>
                        <p><strong>User:</strong> ${user?.user_name || 'N/A'} (ID: ${withdrawal.id})</p>
                        <p><strong>Amount:</strong> UGX ${(withdrawal.amount || 0).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="status-${withdrawal.status}">${withdrawal.status}</span></p>
                        <p><strong>Payment Method:</strong> ${withdrawal.payment_method || 'N/A'}</p>
                        <p><strong>Phone/Account:</strong> ${withdrawal.phone_number || withdrawal.email || 'N/A'}</p>
                        <p><strong>Wallet Type:</strong> ${withdrawal.wallet_type || 'N/A'}</p>
                        <p><strong>Created:</strong> ${created}</p>
                    </div>
                    
                    ${withdrawal.status === 'pending' ? `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="processWithdrawal(${requestId}, 'approve')" class="btn btn-success" style="margin-right: 10px;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="processWithdrawal(${requestId}, 'reject')" class="btn btn-danger">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                    ` : ''}
                `;

                showCustomModal('Withdrawal Details', modalContent);

            } catch (error) {
                console.error('Error viewing withdrawal:', error);
                showNotification('Error loading withdrawal details', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load referrals
        async function loadReferrals() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.referrals;
                const offset = (page - 1) * limit;

                const { data, count, error } = await AdminApp.supabase
                    .from('refferals')
                    .select(`
                        *,
                        inviter:users!refferals_inviter_id_fkey (
                            user_name,
                            email_address
                        ),
                        referred:users!refferals_referred_id_fkey (
                            user_name,
                            email_address
                        ),
                        secondary:users!refferals_secondary_benefit_fkey (
                            user_name
                        )
                    `, { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.referrals = data || [];
                AdminApp.pagination.referrals.total = count || 0;

                updateReferralsTable();
                updateReferralsPagination();
                loadReferralCharts();

            } catch (error) {
                console.error('Error loading referrals:', error);
                showNotification('Error loading referrals: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update referrals table
        function updateReferralsTable() {
            const tbody = document.getElementById('referralsTableBody');

            if (!AdminApp.data.referrals.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            No referrals found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.referrals.forEach(referral => {
                const created = new Date(referral.created_at).toLocaleDateString();
                const level = referral.secondary_benefit ? 2 : 1;
                const earnings = level === 1 ? 'UGX 7,000' : 'UGX 4,000';

                html += `
                    <tr>
                        <td>${referral.referral_id}</td>
                        <td>${referral.inviter?.user_name || 'N/A'} (${referral.inviter_id})</td>
                        <td>${referral.referred?.user_name || 'N/A'} (${referral.referred_id})</td>
                        <td>${level}</td>
                        <td>${referral.secondary?.user_name || 'N/A'}</td>
                        <td>${created}</td>
                        <td>${earnings}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Load referral charts
        async function loadReferralCharts() {
            // Referral levels chart
            const ctx1 = document.getElementById('referralLevelsChart').getContext('2d');

            const level1 = AdminApp.data.referrals.filter(r => !r.secondary_benefit).length;
            const level2 = AdminApp.data.referrals.filter(r => r.secondary_benefit).length;

            if (AdminApp.charts.referralLevels) {
                AdminApp.charts.referralLevels.destroy();
            }

            AdminApp.charts.referralLevels = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['Level 1', 'Level 2'],
                    datasets: [{
                        data: [level1, level2],
                        backgroundColor: ['#3498db', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Top referrers chart
            const ctx2 = document.getElementById('topReferrersChart').getContext('2d');

            // Count referrals by inviter
            const referrerCounts = {};
            AdminApp.data.referrals.forEach(r => {
                if (r.inviter_id) {
                    referrerCounts[r.inviter_id] = (referrerCounts[r.inviter_id] || 0) + 1;
                }
            });

            const topReferrers = Object.entries(referrerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = topReferrers.map(([id]) => `User ${id}`);
            const data = topReferrers.map(([, count]) => count);

            if (AdminApp.charts.topReferrers) {
                AdminApp.charts.topReferrers.destroy();
            }

            AdminApp.charts.topReferrers = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Referrals',
                        data: data,
                        backgroundColor: '#2ecc71'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Load contents
        async function loadContents() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.contents;
                const offset = (page - 1) * limit;

                let query = AdminApp.supabase
                    .from('contents')
                    .select(`
                        *,
                        users (
                            user_name
                        )
                    `, { count: 'exact' });

                // Apply filters
                if (AdminApp.filters.contents.type) {
                    query = query.eq('content_type', AdminApp.filters.contents.type);
                }

                const { data, count, error } = await query
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.contents = data || [];
                AdminApp.pagination.contents.total = count || 0;

                updateContentsTable();
                updateContentsPagination();

            } catch (error) {
                console.error('Error loading contents:', error);
                showNotification('Error loading contents: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update contents table
        function updateContentsTable() {
            const tbody = document.getElementById('contentsTableBody');
            if (!tbody) return;

            if (!AdminApp.data.contents.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            No contents found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.contents.forEach(content => {
                const created = new Date(content.created_at).toLocaleDateString();

                html += `
                    <tr>
                        <td>${content.post_id}</td>
                        <td>${content.content_title || 'N/A'}</td>
                        <td><span class="status-badge">${content.content_type || 'N/A'}</span></td>
                        <td>${content.id} (${content.users?.user_name || 'N/A'})</td>
                        <td>${content.total_actions || 0}</td>
                        <td>${created}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editContent(${content.post_id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteContent(${content.post_id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Show add content modal
        function showAddContentModal() {
            const contentModalTitleEl = document.getElementById('contentModalTitle');
            if (contentModalTitleEl) contentModalTitleEl.textContent = 'Add Content';

            const contentFormEl = document.getElementById('contentForm');
            if (contentFormEl) {
                try { contentFormEl.reset(); } catch (e) {}
                contentFormEl.dataset.contentId = '';
            }

            showModal('contentModal');
        }

        // Handle content form submission
        async function handleContentFormSubmit(e) {
            e.preventDefault();

            const contentId = e.target.dataset.contentId;
            const title = document.getElementById('modalContentTitle').value;
            const type = document.getElementById('modalContentType').value;
            const userId = document.getElementById('modalContentUserId').value;
            const url = document.getElementById('modalContentUrl').value;
            const description = document.getElementById('modalContentDescription').value;
            const actions = document.getElementById('modalContentActions').value;

            try {
                showLoading();

                const contentData = {
                    content_title: title,
                    content_type: type,
                    id: parseInt(userId),
                    total_actions: parseInt(actions)
                };

                if (url) contentData.content_url = url;
                if (description) contentData.description = description;

                if (contentId) {
                    // Update existing content
                    const { error } = await AdminApp.supabase
                        .from('contents')
                        .update(contentData)
                        .eq('post_id', contentId);

                    if (error) throw error;

                    showNotification('Content updated successfully', 'success');
                } else {
                    // Create new content
                    const { error } = await AdminApp.supabase
                        .from('contents')
                        .insert(contentData);

                    if (error) throw error;

                    showNotification('Content created successfully', 'success');
                }

                closeModal();
                loadContents();

            } catch (error) {
                console.error('Error saving content:', error);
                showNotification('Error saving content: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Load payments
        async function loadPayments() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.payments;
                const offset = (page - 1) * limit;

                const { data, count, error } = await AdminApp.supabase
                    .from('payment_information')
                    .select(`
                        *,
                        users (
                            user_name
                        )
                    `, { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.payments = data || [];
                AdminApp.pagination.payments.total = count || 0;

                updatePaymentsTable();
                updatePaymentsPagination();

            } catch (error) {
                console.error('Error loading payments:', error);
                showNotification('Error loading payments: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update payments table
        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');

            if (!AdminApp.data.payments.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            No payment information found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.payments.forEach(payment => {
                const user = payment.users;

                html += `
                    <tr>
                        <td>${payment.id}</td>
                        <td>${payment.id}</td>
                        <td>${user?.user_name || 'N/A'}</td>
                        <td>${payment.mobile_number || 'N/A'}</td>
                        <td>${payment.payment_method || 'N/A'}</td>
                        <td>${payment.email || 'N/A'}</td>
                        <td>${payment.notification_preference || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editPayment(${payment.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Load statistics
        async function loadStatistics() {
            showLoading();

            try {
                // Load all stats
                const [
                    usersStats,
                    earningsStats,
                    withdrawalStats,
                    referralStats,
                    contentStats,
                    todayStats
                ] = await Promise.all([
                    getUsersStats(),
                    getEarningsStats(),
                    getWithdrawalStats(),
                    getReferralStats(),
                    getContentStats(),
                    getTodayStats()
                ]);

                AdminApp.data.statistics = {
                    users: usersStats,
                    earnings: earningsStats,
                    withdrawals: withdrawalStats,
                    referrals: referralStats,
                    contents: contentStats,
                    today: todayStats
                };

                updateStatisticsDisplay();
                loadStatisticsCharts();

            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Error loading statistics: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function getUsersStats() {
            const { count: total, error: totalError } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true });

            if (totalError) throw totalError;

            const { count: active, error: activeError } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'active');

            if (activeError) throw activeError;

            const { count: admins, error: adminsError } = await AdminApp.supabase
                .from('users')
                .select('*', { count: 'exact', head: true })
                .eq('rank', 'admin');

            if (adminsError) throw adminsError;

            return { total, active, admins };
        }

        async function getContentStats() {
            const { count: total, error: totalError } = await AdminApp.supabase
                .from('contents')
                .select('*', { count: 'exact', head: true });

            if (totalError) throw totalError;

            // Count by type
            const { data: byType, error: typeError } = await AdminApp.supabase
                .from('contents')
                .select('content_type');

            if (typeError) throw typeError;

            const typeCounts = {};
            byType.forEach(c => {
                typeCounts[c.content_type] = (typeCounts[c.content_type] || 0) + 1;
            });

            return { total, byType: typeCounts };
        }

        async function getTodayStats() {
            const today = new Date().toISOString().split('T')[0];

            const [
                usersToday,
                earningsToday,
                withdrawalsToday,
                referralsToday
            ] = await Promise.all([
                AdminApp.supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today),

                AdminApp.supabase
                    .from('earnings')
                    .select('all_time_earn')
                    .gte('created_at', today),

                AdminApp.supabase
                    .from('withdrawal_requests')
                    .select('amount')
                    .gte('created_at', today),

                AdminApp.supabase
                    .from('refferals')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today)
            ]);

            const earningsTotal = earningsToday.data?.reduce((sum, e) => sum + (e.all_time_earn || 0), 0) || 0;
            const withdrawalsTotal = withdrawalsToday.data?.reduce((sum, w) => sum + (w.amount || 0), 0) || 0;

            return {
                users: usersToday.count || 0,
                earnings: earningsTotal,
                withdrawals: withdrawalsTotal,
                referrals: referralsToday.count || 0
            };
        }

        function updateStatisticsDisplay() {
            const stats = AdminApp.data.statistics;

            // Update stats grid
            const grid = document.querySelector('#statistics .stats-grid');

            grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>User Statistics</h3>
                            <p class="stat-label">Active: ${stats.users.active}</p>
                        </div>
                        <div class="stat-icon icon-users">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.users.total.toLocaleString()}</div>
                    <p>Admins: ${stats.users.admins}</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Financial Overview</h3>
                            <p class="stat-label">Available: UGX ${stats.earnings.available.toLocaleString()}</p>
                        </div>
                        <div class="stat-icon icon-income">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${stats.earnings.total.toLocaleString()}</div>
                    <p>Withdrawn: UGX ${stats.earnings.withdrawn.toLocaleString()}</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Withdrawal Summary</h3>
                            <p class="stat-label">Pending: UGX ${stats.withdrawals.pending.toLocaleString()}</p>
                        </div>
                        <div class="stat-icon icon-withdrawals">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-value">UGX ${stats.withdrawals.total.toLocaleString()}</div>
                    <p>Approved: UGX ${stats.withdrawals.approved.toLocaleString()}</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Referral Network</h3>
                            <p class="stat-label">Level 1: ${stats.referrals.l1}</p>
                        </div>
                        <div class="stat-icon icon-referrals">
                            <i class="fas fa-network-wired"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.referrals.total.toLocaleString()}</div>
                    <p>Level 2: ${stats.referrals.l2}</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Content Library</h3>
                            <p class="stat-label">Total contents</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.contents.total.toLocaleString()}</div>
                    <p>Various types</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3>Today's Activity</h3>
                            <p class="stat-label">New users: ${stats.today.users}</p>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.today.referrals}</div>
                    <p>New referrals today</p>
                </div>
            `;

            // Update statistics table
            const tbody = document.getElementById('statisticsTableBody');

            const now = new Date();
            const lastUpdated = now.toLocaleString();

            tbody.innerHTML = `
                <tr>
                    <td>Total Users</td>
                    <td>${stats.users.total}</td>
                    <td>+${stats.today.users} today</td>
                    <td><span class="change-positive"><i class="fas fa-arrow-up"></i> Growing</span></td>
                    <td>${lastUpdated}</td>
                </tr>
                <tr>
                    <td>Total Earnings</td>
                    <td>UGX ${stats.earnings.total.toLocaleString()}</td>
                    <td>+UGX ${stats.today.earnings.toLocaleString()} today</td>
                    <td><span class="change-positive"><i class="fas fa-arrow-up"></i> Growing</span></td>
                    <td>${lastUpdated}</td>
                </tr>
                <tr>
                    <td>Total Withdrawals</td>
                    <td>UGX ${stats.withdrawals.total.toLocaleString()}</td>
                    <td>+UGX ${stats.today.withdrawals.toLocaleString()} today</td>
                    <td><span class="${stats.today.withdrawals > 0 ? 'change-positive' : 'change-negative'}">
                        <i class="fas fa-${stats.today.withdrawals > 0 ? 'arrow-up' : 'arrow-down'}"></i> 
                        ${stats.today.withdrawals > 0 ? 'Active' : 'Quiet'}
                    </span></td>
                    <td>${lastUpdated}</td>
                </tr>
                <tr>
                    <td>Pending Withdrawals</td>
                    <td>UGX ${stats.withdrawals.pending.toLocaleString()}</td>
                    <td>Requires action</td>
                    <td><span class="change-negative"><i class="fas fa-exclamation-circle"></i> Attention needed</span></td>
                    <td>${lastUpdated}</td>
                </tr>
                <tr>
                    <td>Active Referrals</td>
                    <td>${stats.referrals.total}</td>
                    <td>+${stats.today.referrals} today</td>
                    <td><span class="change-positive"><i class="fas fa-arrow-up"></i> Growing</span></td>
                    <td>${lastUpdated}</td>
                </tr>
                <tr>
                    <td>Available Balance</td>
                    <td>UGX ${stats.earnings.available.toLocaleString()}</td>
                    <td>System balance</td>
                    <td><span class="change-positive"><i class="fas fa-check-circle"></i> Healthy</span></td>
                    <td>${lastUpdated}</td>
                </tr>
            `;
        }

        function loadStatisticsCharts() {
            // Income chart
            const ctx1 = document.getElementById('incomeChart').getContext('2d');

            if (AdminApp.charts.income) {
                AdminApp.charts.income.destroy();
            }

            const stats = AdminApp.data.statistics.earnings;

            AdminApp.charts.income = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Total', 'Withdrawn', 'Available', 'Pending'],
                    datasets: [{
                        label: 'Amount (UGX)',
                        data: [
                            stats.total,
                            stats.withdrawn,
                            stats.available,
                            AdminApp.data.statistics.withdrawals.pending
                        ],
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#2ecc71',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'UGX ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // User distribution chart
            const ctx2 = document.getElementById('userDistributionChart').getContext('2d');

            if (AdminApp.charts.userDistribution) {
                AdminApp.charts.userDistribution.destroy();
            }

            const userStats = AdminApp.data.statistics.users;

            AdminApp.charts.userDistribution = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Active Users', 'Inactive Users', 'Admins'],
                    datasets: [{
                        data: [
                            userStats.active,
                            userStats.total - userStats.active - userStats.admins,
                            userStats.admins
                        ],
                        backgroundColor: [
                            '#2ecc71',
                            '#e74c3c',
                            '#3498db'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load audit log
        async function loadAuditLog() {
            showLoading();

            try {
                const { page, limit } = AdminApp.pagination.audit;
                const offset = (page - 1) * limit;

                let query = AdminApp.supabase
                    .from('user_sync_audit')
                    .select('*', { count: 'exact' });

                // Apply filters
                if (AdminApp.filters.audit.action) {
                    query = query.ilike('action', `%${AdminApp.filters.audit.action}%`);
                }

                if (AdminApp.filters.audit.status) {
                    query = query.eq('status', AdminApp.filters.audit.status);
                }

                if (AdminApp.filters.audit.dateFrom) {
                    query = query.gte('created_at', AdminApp.filters.audit.dateFrom);
                }

                if (AdminApp.filters.audit.dateTo) {
                    query = query.lte('created_at', AdminApp.filters.audit.dateTo);
                }

                const { data, count, error } = await query
                    .order('created_at', { ascending: false })
                    .range(offset, offset + limit - 1);

                if (error) throw error;

                AdminApp.data.audit = data || [];
                AdminApp.pagination.audit.total = count || 0;

                updateAuditTable();
                updateAuditPagination();

            } catch (error) {
                console.error('Error loading audit log:', error);
                showNotification('Error loading audit log: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Update audit table
        function updateAuditTable() {
            const tbody = document.getElementById('auditTableBody');

            if (!AdminApp.data.audit.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            No audit log entries found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            AdminApp.data.audit.forEach(log => {
                const created = new Date(log.created_at).toLocaleString();
                const statusClass = log.status === 'success' ? 'status-success' : 'status-error';

                html += `
                    <tr>
                        <td>${log.id}</td>
                        <td>${log.auth_user_id || 'System'}</td>
                        <td>${log.action}</td>
                        <td><span class="${statusClass}">${log.status}</span></td>
                        <td>${log.error_message || '-'}</td>
                        <td>${created}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Filter audit log
        function filterAuditLog() {
            AdminApp.filters.audit = {
                action: document.getElementById('auditActionFilter').value,
                status: document.getElementById('auditStatusFilter').value,
                dateFrom: document.getElementById('auditDateFrom').value,
                dateTo: document.getElementById('auditDateTo').value
            };

            AdminApp.pagination.audit.page = 1;
            loadAuditLog();
        }

        // Clear old audit logs
        async function clearAuditLog() {
            if (!confirm('Are you sure you want to clear audit logs older than 30 days?')) {
                return;
            }

            try {
                showLoading();

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { error } = await AdminApp.supabase
                    .from('user_sync_audit')
                    .delete()
                    .lt('created_at', thirtyDaysAgo.toISOString());

                if (error) throw error;

                showNotification('Old audit logs cleared successfully', 'success');
                loadAuditLog();

            } catch (error) {
                console.error('Error clearing audit log:', error);
                showNotification('Error clearing audit log: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Load settings
        async function loadSettings() {
            // This would load system settings from your database
            const container = document.querySelector('.settings-container');

            container.innerHTML = `
                <div class="table-container">
                    <div style="padding: 20px;">
                        <h3 style="margin-bottom: 20px;">System Configuration</h3>
                        
                        <div class="form-group">
                            <label>Site Name</label>
                            <input type="text" id="siteName" value="SkyLink" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Default Bonus Amount (UGX)</label>
                            <input type="number" id="defaultBonus" value="5000" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Minimum Withdrawal Amount (UGX)</label>
                            <input type="number" id="minWithdrawal" value="59000" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Referral Earnings (L1)</label>
                            <input type="number" id="referralL1" value="7000" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Referral Earnings (L2)</label>
                            <input type="number" id="referralL2" value="4000" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Task Cooldown (hours)</label>
                            <input type="number" id="taskCooldown" value="48" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label>Enable Email Notifications</label>
                            <input type="checkbox" id="enableEmail" checked>
                        </div>
                        
                        <div class="form-group">
                            <label>Maintenance Mode</label>
                            <input type="checkbox" id="maintenanceMode">
                        </div>
                        
                        <div class="form-group">
                            <label>Maintenance Message</label>
                            <textarea id="maintenanceMessage" rows="3" style="width: 100%;">System is undergoing maintenance. Please check back later.</textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // Save settings
        async function saveSettings() {
            // This would save settings to your database
            showNotification('Settings saved successfully', 'success');
        }

        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to users table changes
            const usersChannel = AdminApp.supabase
                .channel('users-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'users' },
                    () => {
                        if (AdminApp.currentSection === 'dashboard' ||
                            AdminApp.currentSection === 'users' ||
                            AdminApp.currentSection === 'statistics') {
                            loadSectionData(AdminApp.currentSection);
                        }
                    }
                )
                .subscribe();

            // Subscribe to withdrawals changes
            const withdrawalsChannel = AdminApp.supabase
                .channel('withdrawals-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'withdrawal_requests' },
                    () => {
                        if (AdminApp.currentSection === 'dashboard' ||
                            AdminApp.currentSection === 'withdrawals' ||
                            AdminApp.currentSection === 'statistics') {
                            loadSectionData(AdminApp.currentSection);
                        }
                    }
                )
                .subscribe();

            // Store channels for cleanup
            AdminApp.channels = {
                users: usersChannel,
                withdrawals: withdrawalsChannel
            };
        }

        // Logout
        async function logout() {
            try {
                showLoading();

                await AdminApp.supabase.auth.signOut();

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } catch (error) {
                console.error('Error logging out:', error);
                showNotification('Error logging out', 'error');
                hideLoading();
            }
        }

        // Modal functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('modalOverlay');

            modal.style.display = 'block';
            overlay.style.display = 'flex';

            // Add to body to prevent scrolling
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modals = document.querySelectorAll('.modal');
            const overlay = document.getElementById('modalOverlay');

            modals.forEach(modal => modal.style.display = 'none');
            overlay.style.display = 'none';

            // Restore scrolling
            document.body.style.overflow = 'auto';
        }

        function showCustomModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            `;

            document.getElementById('modalOverlay').appendChild(modal);
            showModal(modal);
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Notification functions
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            `;

            container.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        // Utility functions
        function generatePassword(length = 12) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Quick action handlers
        function handleQuickAction(action) {
            switch (action) {
                case 'addUser':
                    showAddUserModal();
                    break;
                case 'processWithdrawals':
                    switchSection('withdrawals');
                    break;
                case 'sendNotification':
                    // Implement notification sending
                    showNotification('Notification feature coming soon!', 'info');
                    break;
                case 'generateReport':
                    // Implement report generation
                    showNotification('Report generation coming soon!', 'info');
                    break;
            }
        }

        // Export functions
        function exportUsers() {
            const data = AdminApp.data.users;
            if (!data.length) {
                showNotification('No users to export', 'warning');
                return;
            }

            const csv = convertToCSV(data);
            downloadCSV(csv, 'users_export.csv');
            showNotification('Users exported successfully', 'success');
        }

        function exportStatistics() {
            const stats = AdminApp.data.statistics;
            const data = [{
                metric: 'Total Users',
                value: stats.users.total,
                date: new Date().toISOString()
            }, {
                metric: 'Total Earnings',
                value: stats.earnings.total,
                date: new Date().toISOString()
            }];

            const csv = convertToCSV(data);
            downloadCSV(csv, 'statistics_export.csv');
            showNotification('Statistics exported successfully', 'success');
        }

        function convertToCSV(objArray) {
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = '';

            // Headers
            const headers = Object.keys(array[0]);
            str += headers.join(',') + '\r\n';

            // Data
            for (let i = 0; i < array.length; i++) {
                let line = '';
                for (const header of headers) {
                    if (line !== '') line += ',';
                    line += array[i][header];
                }
                str += line + '\r\n';
            }

            return str;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Make functions available globally
        window.switchSection = switchSection;
        window.loadUsers = loadUsers;
        window.changeUsersPage = changeUsersPage;
        window.filterUsers = filterUsers;
        window.searchUsers = searchUsers;
        window.showAddUserModal = showAddUserModal;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.loadEarnings = loadEarnings;
        window.filterEarnings = filterEarnings;
        window.loadWithdrawals = loadWithdrawals;
        window.filterWithdrawals = filterWithdrawals;
        window.processWithdrawal = processWithdrawal;
        window.processSelectedWithdrawals = processSelectedWithdrawals;
        window.viewWithdrawal = viewWithdrawal;
        window.loadReferrals = loadReferrals;
        window.loadReferralStats = loadReferrals;
        window.loadContents = loadContents;
        window.filterContents = filterContents;
        window.searchContents = function (query) {
            console.log('Searching contents:', query);
        };
        window.showAddContentModal = showAddContentModal;
        window.editContent = function (id) {
            // Implement edit content
            showNotification('Edit content feature coming soon!', 'info');
        };
        window.deleteContent = function (id) {
            if (confirm('Are you sure you want to delete this content?')) {
                showNotification('Content deleted', 'success');
            }
        };
        window.loadPayments = loadPayments;
        window.editPayment = function (id) {
            showNotification('Edit payment feature coming soon!', 'info');
        };
        window.loadStatistics = loadStatistics;
        window.refreshStatistics = loadStatistics;
        window.exportStatistics = exportStatistics;
        window.loadSettings = loadSettings;
        window.saveSettings = saveSettings;
        window.loadAuditLog = loadAuditLog;
        window.filterAuditLog = filterAuditLog;
        window.clearAuditLog = clearAuditLog;
        window.closeModal = closeModal;
        window.updateAllEarnings = function () {
            showNotification('Updating all earnings...', 'info');
            // Implement earnings update logic
        };
        window.loadRecentActivities = function () {
            showNotification('Refreshing recent activities...', 'info');
            // Implement refresh logic
        };
    </script>
</body>
<script src="admin-mobile.js"></script>

</html>